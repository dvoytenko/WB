<html>

<body>

<style>
	body {
		margin: 0px;
		padding: 0px;
	}
	canvas {
		border: 1px solid #9C9898;
	}

	.progress {
		display: none;
	}
	
	#FormulaDisplay.loading .progress {
		display: block;
	}
	
	#FormulaDisplay .WaitingForAction {
		display: none;
		margin-top: 10px;
	}

	#FormulaDisplay.nocontent .WaitingForAction {
		display: block;
	}
	
	#FormulaDisplay.loading #Toolbar,
		#FormulaDisplay.loading #container {
		display: none;
	}

	#FormulaDisplay.nocontent .Toolbar,
		#FormulaDisplay.nocontent #container {
		display: none;
	}

</style>

	<div>Enter formula here:</div>
	<textarea id="formula" style="width: 500px; height: 120px;">\sum _{n=1}^{\infty } \frac{1}{n^2}=\frac{\pi ^2}{6}</textarea>
	
	<div>
		<input id="generateButton" type="button" value="Generate"/>
	</div>
	
	<div id="FormulaDisplay" class="nocontent">
	
		<div class="WaitingForAction">
			Please enter a formula in a LaTeX format and click generate.
		</div>
		
		<div class="progress">
			<img src="loading.gif"/>
		</div>
	
		<div class="Toolbar">
			<a class="PlayToggle" href="javascript:void(0);">Play</a>
		</div>
					
		<div id="container" style="position: relative; margin: 4px; padding: 0; width: 490px; height: 405px;">
			<!--
			<canvas id="gridCanvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 1;"></canvas>
			-->
			<canvas id="canvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 2;"></canvas>
			<canvas id="animCanvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 3;"></canvas>
			<canvas id="pointerCanvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 4;"></canvas>
		</div>
	</div>

	<script type="text/javascript">
	
		var baseVelocity = 1000;
		var defaultTransform = new WB.Transform();
		
		var pane = new WB.Pane({canvas: document.getElementById('canvas'),
			defaultTransform: defaultTransform});
		var animationPane = new WB.Pane({canvas: document.getElementById('animCanvas'), 
			defaultTransform: defaultTransform});
		var pointerPane = new WB.Pane({canvas: document.getElementById('pointerCanvas'),
			defaultTransform: defaultTransform});

		var board = new WB.Board({
			commitPane: pane,
			animationPane: animationPane,
			baseVelocity: baseVelocity,
			showBounds: false
			});

		var player = new WB.Player({board: board});

		player.bind(function(event, opts) {
			if (event == 'frame') {
				var p = player.board.animationPane.getCurrentPoint();
				//status('Time: ' + (opts.time) + ' milliseconds' 
				//		+ '; Position: ' + Math.round(p.x) + ',' + Math.round(p.y));
			} else if (event == 'state') {
				updatePlayerState(opts.state);
			}
		});
		
		$('a.PlayToggle').click(playToggle);
		
		function updatePlayerState(state) {
			var a = $('a.PlayToggle');
			if (!state || state == 'none' || state == 'ended' || state == 'cancelled') {
				a.text('Play');
			} else if (state == 'playing') {
				a.text('Suspend');
			} else if (state == 'suspended') {
				a.text('Resume');
			}
		}
		
		function shapeLoaded(shape) {
			var preparedShape = shape;
			
			board.preparedShape = preparedShape;
			board.cancel();
			preparedShape.draw(pane);
			updatePlayerState('none');
		}
		
		function playToggle() {
			var state = player.state;
			console.log('play toggle at ' + state);

			if (!state || state == 'none' || state == 'ended' || state == 'cancelled') {
				if (board.preparedShape) {
					pane._clearCanvas();
					animationPane._clearCanvas();
					player.playAny(board.preparedShape);
				}
			} else if (state == 'playing') {
				player.suspend();
			} else if (state == 'suspended') {
				player.resume();
			}
		}
		
		function generate() {
			
			$('#FormulaDisplay').toggleClass('nocontent', false);
			$('#FormulaDisplay').toggleClass('progress', true);
			
			player.cancel();
			board.cancel();
			
	    	var formula = $('#formula').val();
	    	console.log('formula: ' + formula);
			$.ajax({
				type: 'POST',
				url: '/wb/service/latex/gen',
				data: {
					formula: formula
				}
			}).done(function(data) {
				console.log('done!');
				console.log(data);
				if (data) {
					if (data.constructor == String) {
						data = JSON.parse(data);
						console.log(data);
					}
					
					var parser = new WB.Parser();
					var shape = parser.parse(data.shape);
					console.log(shape);

					$('#FormulaDisplay').toggleClass('progress', false);
					
					var tr = new WB.Transform();
					tr.scale(2, 2);
					var group = new WB.GroupShape({transform: tr, shapes: [shape]});
					shapeLoaded(group);
				} else {
					$('#FormulaDisplay').toggleClass('nocontent', true);
				}
			});
		}
		
    	$('#generateButton').click(function() {
    		generate();
    	});
	</script>
	
</body>
</html>
