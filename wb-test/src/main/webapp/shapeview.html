<html>

<body>

<style>
	body {
		margin: 0px;
		padding: 0px;
	}
	canvas {
		border: 1px solid #9C9898;
	}

	.progress {
		display: none;
	}
	
	#ImageViewer {
		width: 1000px;
	}

	#ImageViewer.loading .progress {
		display: block;
	}

	#ImageViewer.loading #ImageListPane,
		#ImageViewer.loading #ImagePane {
		display: none;
	}

	#ImageViewer.nocontent #ImageListPane,
		#ImageViewer.nocontent #ImagePane {
		display: none;
	}
	
	#ImagePane {
		float: left; 
		width: 520px;
	}
	
	#ImageListPane {
		float: right; 
		width: 460px;
	}

	#ShapeDescListView {
		height: 500px;
		overflow-y: auto;
	}
	
	#ShapeDescListView::-webkit-scrollbar-track {
		-webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
		border-radius: 10px;
	}

	.ShapeDesc {
		cursor: pointer;
		border: 1px solid gray;
		margin-left: 4px;
		display: inline-block;
		float: left;
	}
	
	.ShapeDesc .Title {
		max-width: 100px;
		white-space: nowrap;
		overflow-x: hidden;
		text-overflow: ellipsis;
		font-size: smaller;
	}

	.ShapeDesc .Source {
		display: none;
	}
	
	.ShapeDesc .Thumb img {
		width: 100px;
		height: 100px;
	}


	#ShapeDetailView {
		display: none;
	}
	
	#ImagePane.content #ShapeDetailView {
		display: block;
	}

	#ImagePane .WaitingForAction {
		display: block;
	}

	#ImagePane.content .WaitingForAction {
		display: none;
	}

	#ShapeDetailView .Thumb {
		float: left;
		margin: 4px;
	}
	
	#ShapeDetailView .Thumb img {
		width: 50px;
		height: 50px;
	}

	#ShapeDetailView .Id {
		display: none;
	}
	
	#ShapeDetailView .Toolbar {
		clear: both;
	}
	
</style>

	<div class="ImageViewer">
	
		<div id="ImagePane">
			<div class="WaitingForAction" style="margin: 100px;">
				Please select a shape on the right.
			</div>
			<div id="ShapeDetailView">
				<div class="Thumb"><img/></div>
				<div class="Id"></div>
				<div class="Title"></div>
				<div class="Source"><a target="_blank"></a></div>
				
				<div class="Toolbar">
					<a class="PlayToggle" href="javascript:void(0);">Play</a>
				</div>
				
				<div id="container" style="position: relative; margin: 4px; padding: 0; width: 490px; height: 405px;">
					<!--
					<canvas id="gridCanvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 1;"></canvas>
					-->
					<canvas id="canvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 2;"></canvas>
					<canvas id="animCanvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 3;"></canvas>
					<canvas id="pointerCanvas" width="490" height="405" style="position: absolute; margin: 0; width: 490px; height: 405px; z-index: 4;"></canvas>
				</div>
				
			</div>
		</div>
		
		<div id="ImageListPane">
			<div id="ShapeDescListView"></div>
		</div>
	</div>

	
	<div id="templates" style="display: none;">
		<div id="ShapeDescView" class="ShapeDesc">
			<div class="Title"></div>
			<div class="Source"></div>
			<div class="Thumb"><img/></div>
		</div>
	</div>

	<script type="text/javascript">
		var ShapeDesc = Backbone.Model.extend({
			remove: function() {
				this.destroy();
			}
		});
		
	
		var ShapeDetailView = Backbone.View.extend({
			
			el: $('#ShapeDetailView'),
			
			events: {
				'click a.PlayToggle': 'playToggle'
			},
			
			initialize: function() {
				
				var baseVelocity = 1000;
				var defaultTransform = new WB.Transform();
				
				this.pane = new WB.Pane({canvas: document.getElementById('canvas'),
					defaultTransform: defaultTransform});
				this.animationPane = new WB.Pane({canvas: document.getElementById('animCanvas'), 
					defaultTransform: defaultTransform});
				this.pointerPane = new WB.Pane({canvas: document.getElementById('pointerCanvas'),
					defaultTransform: defaultTransform});
				
				// drawingSoundEngine: new WB.DrawingSoundEngine({})
				// pointer: new WB.HandPoint({pane: this.pointerPane})
				// speechPlayer: new WB.SpeechPlayer({urlResolver: opts.urlResolver})
				// urlResolver: opts.urlResolver
				this.board = new WB.Board({
					commitPane: this.pane,
					animationPane: this.animationPane,
					baseVelocity: baseVelocity,
					showBounds: false
					});

				this.player = new WB.Player({board: this.board});
				
				var that = this;
				that.player.bind(function(event, opts) {
					if (event == 'frame') {
						var p = that.player.board.animationPane.getCurrentPoint();
						//status('Time: ' + (opts.time) + ' milliseconds' 
						//		+ '; Position: ' + Math.round(p.x) + ',' + Math.round(p.y));
					} else if (event == 'state') {
						that.updatePlayerState(opts.state);
					}
				});
			},			

			render: function() {
			},
			
			setShape: function(descModel) {
				this.model = descModel;
				var model = this.model.toJSON();
				// console.log('render: ' + JSON.stringify(model));

				this.player.cancel();
				this.board.cancel();
				
				this.$el.find('div.Id').text(model.id);
				this.$el.find('div.Title').text(model.title);
				if (model.source) {
					this.$el.find('div.Source a').text(model.source);
					this.$el.find('div.Source a').attr('href', model.url);
				}
				this.$el.find('div.Thumb img').attr('src', '/wb/shapedb/' + model.id + '.png');

				var that = this;
				$.ajax({url: '/wb/shapedb/' + model.id + '.json', contentType: 'application/json'})
				.done(function(json) {
					console.log('got data');
					if (json) {
						if (json.constructor == String) {
							json = JSON.parse(json);
						}
						console.log(json);
						
						var parser = new WB.Parser();
						var shape = parser.parse(json);
						console.log(shape);
						
						that.shapeLoaded(shape, true);
					}
				});
				
				$('#ImagePane').toggleClass('content', true);
				
				return this;
			},
			
			shapeLoaded: function(shape, doRender) {
				
				this.shape = shape;

				var tr = new WB.Transform();
				console.log(shape.localBounds);
				if (shape.localBounds) {
					
					var dWidth = this.pane.canvas.width;
					var dHeight = this.pane.canvas.height;
					var lWidth = Math.abs(shape.localBounds.bottomright.x - shape.localBounds.topleft.x);
					var lHeight = Math.abs(shape.localBounds.bottomright.y - shape.localBounds.topleft.y);
					console.log('w/h: ' + dWidth + ' vs ' + lWidth + '; ' + dHeight + ' vs ' + lHeight);
					var scaleX = 1.0;
					var scaleY = 1.0;
					if (Math.abs(dWidth - lWidth) > 1e-2) {
						scaleX = dWidth / lWidth;
					}
					if (Math.abs(dHeight - lHeight) > 1e-2) {
						scaleY = dHeight / lHeight;
					}
					var scale = Math.min(scaleX, scaleY) * 0.9;
					console.log('scale: ' + scale);
					tr.scale(scale, scale);

					// compensate
					tr.translate(-shape.localBounds.topleft.x, 
							-shape.localBounds.topleft.y);

					// center
					var dx = (dWidth - lWidth * scale) / 2;
					var dy = (dHeight - lHeight * scale) / 2;
					console.log('translate: ' + (-shape.localBounds.topleft.x + dx) + 
							', ' + (-shape.localBounds.topleft.y + dy));
					tr.translate(dx/scale, dy/scale);
				}

				var group = new WB.GroupShape({transform: tr, shapes: [shape]});
				this.preparedShape = group;
				
				if (doRender) {
					this.renderShape();
				}
				
				this.updatePlayerState('none');
			},
			
			renderShape: function() {
				if (this.preparedShape) {
					this.board.cancel();
					this.preparedShape.draw(this.pane);
				}
			},
			
			updatePlayerState: function(state) {
				var a = this.$el.find('a.PlayToggle');
				if (!state || state == 'none' || state == 'ended' || state == 'cancelled') {
					a.text('Play');
				} else if (state == 'playing') {
					a.text('Suspend');
				} else if (state == 'suspended') {
					a.text('Resume');
				}
			},
			
			playToggle: function() {
				
				var player = this.player;
				var state = player.state;
				console.log('play toggle at ' + state);

				if (!state || state == 'none' || state == 'ended' || state == 'cancelled') {
					if (this.preparedShape) {
						this.pane._clearCanvas();
						this.animationPane._clearCanvas();
						player.playAny(this.preparedShape);
					}
				} else if (state == 'playing') {
					player.suspend();
				} else if (state == 'suspended') {
					player.resume();
				}
			}
			
		});

		shapeDetailApp = new ShapeDetailView();


		var ShapeDescList = Backbone.Collection.extend({
			
			model: ShapeDesc,
			
			comparator: function(shape) {
				return shape.get('title').toUpperCase();
			}
			
		});
		
		shapeDescListModel = new ShapeDescList();
		
		
		var ShapeDescView = Backbone.View.extend({
			
			tagName: "div",
			className: "ShapeDesc",
			
			skeleton: $('#ShapeDescView').html(),

			events: {
				'click': 'select'
			},

			initialize: function() {
				this.model.bind('destroy', this.remove, this);
			},			
			
			render: function() {
				var model = this.model.toJSON();
				// console.log('render: ' + JSON.stringify(model));
				
				this.$el.html(this.skeleton);
				
				this.$el.find('div.Title').text(model.title);
				if (model.source) {
					this.$el.find('div.Source').text(model.source);
				}
				this.$el.find('div.Thumb img').attr('src', '/wb/shapedb/' + model.id + '.png');
				
				return this;
			},
			
			select: function(e) {
				console.log('select');
				e.stopPropagation();
				shapeDetailApp.setShape(this.model);
				$('.ShapeDesc.selected').toggleClass('selected', false);
				this.$el.toggleClass('selected', true);
			}
			
		});
		
		
		var ShapeDescListView = Backbone.View.extend({
			el: $('#ShapeDescListView'),
			
			model: shapeDescListModel,
			
			initialize: function() {
				this.model.bind('add', this.addOne, this);
				this.model.bind('reset', this.reAddAll, this);
			},

			render: function() {
				return this;
			},
			
			reAddAll: function() {
				this.$el.html('');
				this.model.each(this.addOne, this);
			},			
			
			addOne: function(shapeDescModel) {
				var view = new ShapeDescView({model: shapeDescModel});
				this.$el.append(view.render().el);
			},
			
		});

		shapeDescListApp = new ShapeDescListView();
		shapeDescListApp.render();
	</script>

	<!--
		Load 
	-->
	<script type="text/javascript">
	
		function pullJson(url, success) {
	    	var res = $.getJSON(
	    		url,
	    		function(data) {
	    			console.log('got data for ' + url);
	    			console.log(data);
	    			success(data);
	    		}
	    	);
	    	res.error(function(a, b, c) {
	    		console.log('error in data for ' + url);
	    		console.log(a);
	    		console.log(b);
	    		console.log(c);
	    	});
		}
		
	    $(document).ready(function() {
	    	console.log('!!!internal ready!!!');
	    	pullJson(
		    		'/wb/service/shapedb/',
		    		function(data) {
	    				shapeDescListModel.reset(data);
		    		}
		    	);
	    });
	</script>

</body>
</html>
